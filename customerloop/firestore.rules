rules_version = '2';

// Firestore Security Rules for CustomerLoop
// Last Updated: February 6, 2026
// 
// These rules ensure:
// - Only authenticated users can access data
// - Users can only access their own data
// - Admin operations are restricted
// - Data validation is enforced

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user is accessing their own data
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Check if user is admin (customize based on your admin logic)
    function isAdmin() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    // Validate email format
    function isValidEmail(email) {
      return email.matches('^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$');
    }
    
    // Check if data has required fields
    function hasRequiredFields(data, fields) {
      return data.keys().hasAll(fields);
    }
    
    // ============================================
    // USERS COLLECTION
    // ============================================
    
    // Users can read and write only their own profile
    match /users/{userId} {
      allow read: if isOwner(userId);
      allow create: if isOwner(userId) && 
                    hasRequiredFields(request.resource.data, ['email', 'createdAt']);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId) || isAdmin();
    }
    
    // ============================================
    // CUSTOMERS COLLECTION
    // ============================================
    
    // Business owners can manage their own customers
    match /customers/{customerId} {
      allow read: if isAuthenticated() && 
                  resource.data.businessId == request.auth.uid;
      
      allow create: if isAuthenticated() && 
                    request.resource.data.businessId == request.auth.uid &&
                    hasRequiredFields(request.resource.data, 
                      ['name', 'email', 'phone', 'businessId', 'createdAt']);
      
      allow update: if isAuthenticated() && 
                    resource.data.businessId == request.auth.uid;
      
      allow delete: if isAuthenticated() && 
                    resource.data.businessId == request.auth.uid;
      
      // Customer visits subcollection
      match /visits/{visitId} {
        allow read: if isAuthenticated() && 
                    get(/databases/$(database)/documents/customers/$(customerId)).data.businessId == request.auth.uid;
        
        allow write: if isAuthenticated() && 
                     get(/databases/$(database)/documents/customers/$(customerId)).data.businessId == request.auth.uid;
      }
    }
    
    // ============================================
    // REWARDS COLLECTION
    // ============================================
    
    // Business owners can manage their own rewards
    match /rewards/{rewardId} {
      allow read: if isAuthenticated() && 
                  resource.data.businessId == request.auth.uid;
      
      allow create: if isAuthenticated() && 
                    request.resource.data.businessId == request.auth.uid &&
                    hasRequiredFields(request.resource.data,
                      ['title', 'description', 'pointsCost', 'businessId', 'isActive']);
      
      allow update: if isAuthenticated() && 
                    resource.data.businessId == request.auth.uid;
      
      allow delete: if isAuthenticated() && 
                    resource.data.businessId == request.auth.uid;
    }
    
    // ============================================
    // REDEMPTIONS COLLECTION
    // ============================================
    
    // Track reward redemptions
    match /redemptions/{redemptionId} {
      allow read: if isAuthenticated() && 
                  (resource.data.businessId == request.auth.uid ||
                   resource.data.customerId == request.auth.uid);
      
      allow create: if isAuthenticated() && 
                    request.resource.data.businessId == request.auth.uid &&
                    hasRequiredFields(request.resource.data,
                      ['rewardId', 'customerId', 'businessId', 'redeemedAt', 'status']);
      
      allow update: if isAuthenticated() && 
                    resource.data.businessId == request.auth.uid;
      
      allow delete: if isAdmin();  // Only admins can delete redemptions
    }
    
    // ============================================
    // ANALYTICS COLLECTION
    // ============================================
    
    // Analytics data - read-only for business owners
    match /analytics/{businessId} {
      allow read: if isOwner(businessId);
      allow write: if false;  // Only server-side writes via Cloud Functions
      
      // Time-series data
      match /metrics/{metricId} {
        allow read: if isOwner(businessId);
        allow write: if false;  // Server-side only
      }
    }
    
    // ============================================
    // NOTIFICATIONS COLLECTION
    // ============================================
    
    // User notifications
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && 
                  resource.data.userId == request.auth.uid;
      
      allow create: if isAdmin();  // Only admins/system can create notifications
      
      allow update: if isAuthenticated() && 
                    resource.data.userId == request.auth.uid &&
                    request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read', 'readAt']);
      
      allow delete: if isAuthenticated() && 
                    resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // SETTINGS COLLECTION
    // ============================================
    
    // Business settings
    match /settings/{businessId} {
      allow read: if isOwner(businessId);
      allow write: if isOwner(businessId);
    }
    
    // ============================================
    // ADMIN COLLECTION
    // ============================================
    
    // Admin users list (read-only)
    match /admins/{adminId} {
      allow read: if isAuthenticated();
      allow write: if false;  // Only manual updates via Firebase Console
    }
    
    // ============================================
    // SECURITY TEST COLLECTION
    // ============================================
    
    // Collection for testing security rules
    match /securityTests/{testId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                    request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && 
                    resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && 
                    resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // DEFAULT DENY
    // ============================================
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
